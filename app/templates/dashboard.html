<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare IP Monitor Dashboard</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #15151f;
            --text-primary: #e8e8ed;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7a;
            --accent-primary: #00d4aa;
            --accent-secondary: #00b894;
            --accent-warning: #f39c12;
            --accent-danger: #e74c3c;
            --border-color: #2a2a3a;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            --font-mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }

        .header { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border-bottom: 1px solid var(--border-color); padding: 1.5rem 2rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
        .logo-text { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent-primary), var(--text-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }

        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: var(--bg-primary); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--accent-danger); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        .main { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--accent-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono); color: var(--accent-primary); }
        .stat-sub { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }

        .panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; }
        .panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; background: var(--bg-secondary); }
        .panel-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .panel-body { padding: 1.5rem; }

        .search-box { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .search-input { padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; width: 200px; font-family: inherit; }
        .search-input:focus { outline: none; border-color: var(--accent-primary); }
        .search-input::placeholder { color: var(--text-muted); }
        select.search-input { cursor: pointer; width: auto; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-secondary); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; cursor: pointer; white-space: nowrap; }
        th:hover { color: var(--accent-primary); }
        tr:hover td { background: var(--bg-secondary); }
        td { font-family: var(--font-mono); font-size: 0.8rem; }
        .ip-cell { color: var(--accent-primary); cursor: pointer; }
        .ip-cell:hover { text-decoration: underline; }
        .speed-good { color: var(--accent-primary); }
        .speed-medium { color: var(--accent-warning); }
        .speed-bad { color: var(--accent-danger); }

        .monitor-status { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.875rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.running { background: var(--accent-primary); }
        .status-dot.stopped { background: var(--accent-danger); animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; line-height: 1; }
        .modal-close:hover { color: var(--accent-danger); }
        .modal-body { padding: 1.5rem; max-height: 60vh; overflow-y: auto; }

        .chart-container { height: 200px; display: flex; align-items: flex-end; gap: 4px; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-top: 1rem; }
        .chart-bar { flex: 1; background: linear-gradient(to top, var(--accent-primary), var(--accent-secondary)); border-radius: 4px 4px 0 0; min-height: 4px; transition: all 0.3s ease; }
        .chart-bar:hover { opacity: 0.8; }

        .ip-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .detail-item { background: var(--bg-secondary); padding: 1rem; border-radius: 8px; }
        .detail-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .detail-value { font-size: 1.25rem; font-weight: 600; font-family: var(--font-mono); }

        .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 2000; }
        .toast { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem 1.25rem; margin-top: 0.5rem; box-shadow: var(--shadow); display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease; min-width: 250px; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .toast.success { border-left: 3px solid var(--accent-primary); }
        .toast.error { border-left: 3px solid var(--accent-danger); }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .main { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .panel-header { flex-direction: column; align-items: stretch; }
            .search-box { width: 100%; }
            .search-input { width: 100%; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">&#9729;</div>
                <span class="logo-text">CF IP Monitor</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshData()">Refresh</button>
                <button class="btn btn-secondary" onclick="testNow()">Test Now</button>
                <button class="btn btn-danger" id="header-stop-scan-btn" onclick="stopCurrentScan()" style="display: none;">Stop Scan</button>
                <button class="btn btn-primary" onclick="showScanModal()">Initial Scan</button>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card"><div class="stat-label">Active IPs</div><div class="stat-value" id="stat-active-ips">-</div></div>
            <div class="stat-card"><div class="stat-label">Total Tests</div><div class="stat-value" id="stat-total-tests">-</div></div>
            <div class="stat-card"><div class="stat-label">Avg Speed</div><div class="stat-value" id="stat-avg-speed">-</div><div class="stat-sub">MB/s</div></div>
            <div class="stat-card"><div class="stat-label">Best Speed</div><div class="stat-value" id="stat-best-speed">-</div><div class="stat-sub">MB/s</div></div>
            <div class="stat-card"><div class="stat-label">Avg Latency</div><div class="stat-value" id="stat-avg-latency">-</div><div class="stat-sub">ms</div></div>
            <div class="stat-card"><div class="stat-label">Best Latency</div><div class="stat-value" id="stat-best-latency">-</div><div class="stat-sub">ms</div></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Monitor Status</div>
                <div class="monitor-status">
                    <div class="status-indicator">
                        <div class="status-dot" id="monitor-dot"></div>
                        <span id="monitor-status-text">Loading...</span>
                    </div>
                    <span id="monitor-interval" style="color: var(--text-muted); font-size: 0.875rem;"></span>
                    <span id="monitor-next" style="color: var(--text-muted); font-size: 0.875rem;"></span>
                    <button class="btn btn-sm btn-secondary" id="monitor-toggle-btn" onclick="toggleMonitor()">Start</button>
                    <select class="search-input" id="interval-select" onchange="setMonitorInterval(this.value)" style="width: auto;">
                        <option value="60">1 min</option>
                        <option value="120" selected>2 min</option>
                        <option value="300">5 min</option>
                        <option value="600">10 min</option>
                        <option value="1800">30 min</option>
                        <option value="3600">1 hour</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Scan Scheduler</div>
                <div class="monitor-status">
                    <div class="status-indicator">
                        <div class="status-dot" id="scan-sched-dot"></div>
                        <span id="scan-sched-status-text">Off</span>
                    </div>
                    <span id="scan-running-text" style="color: var(--accent-warning); font-size: 0.875rem;"></span>
                    <button class="btn btn-sm btn-danger" id="scan-stop-btn" onclick="stopCurrentScan()" style="display: none;">Stop Scan</button>
                    <button class="btn btn-sm btn-secondary" id="scan-sched-toggle-btn" onclick="toggleScanSchedule()">Start</button>
                    <select class="search-input" id="scan-interval-select" onchange="setScanScheduleInterval(this.value)" style="width: auto;">
                        <option value="300">5 min</option>
                        <option value="600">10 min</option>
                        <option value="1800">30 min</option>
                        <option value="3600" selected>1 hour</option>
                        <option value="7200">2 hours</option>
                        <option value="14400">4 hours</option>
                        <option value="86400">24 hours</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">IP Addresses</div>
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="Search IP..." oninput="filterIPs()">
                    <select class="search-input" id="sort-select" onchange="sortIPs()">
                        <option value="avg_download_speed">Sort: Speed</option>
                        <option value="avg_latency">Sort: Latency</option>
                        <option value="avg_loss_rate">Sort: Loss Rate</option>
                        <option value="total_tests">Sort: Tests</option>
                        <option value="last_tested">Sort: Last Tested</option>
                    </select>
                    <button class="btn btn-sm btn-secondary" onclick="showCleanDeadModal()" title="Remove IPs with 0 download speed">Clean Dead IPs</button>
                    <button class="btn btn-sm btn-danger" onclick="deactivateAllIPs()" title="Deactivate all active IPs">Delete All</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="table-container">
                    <table id="ip-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Avg Speed</th>
                                <th>Best Speed</th>
                                <th>Avg Latency</th>
                                <th>Best Latency</th>
                                <th>Loss Rate</th>
                                <th>Tests</th>
                                <th>Last Tested</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ip-table-body">
                            <tr><td colspan="9" class="loading"><div class="spinner"></div>Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Hourly Statistics (Last 24h)</div>
            </div>
            <div class="panel-body">
                <div id="hourly-chart" class="chart-container"><div class="loading">Loading chart...</div></div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="ip-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-ip-title">IP Details</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="scan-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Initial Scan Configuration</div>
                <button class="modal-close" onclick="closeScanModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ip-details-grid">
                    <div class="detail-item"><div class="detail-label">Min Speed (MB/s)</div><input type="number" class="search-input" id="scan-min-speed" value="10" style="width: 100%;"></div>
                    <div class="detail-item"><div class="detail-label">Max Latency (ms)</div><input type="number" class="search-input" id="scan-max-latency" value="1000" style="width: 100%;"></div>
                    <div class="detail-item"><div class="detail-label">Max Loss Rate</div><input type="number" class="search-input" id="scan-max-loss" value="0.25" step="0.01" style="width: 100%;"></div>
                    <div class="detail-item"><div class="detail-label">IPs to Test</div><input type="number" class="search-input" id="scan-test-count" value="50" style="width: 100%;"></div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">This will scan all Cloudflare IP ranges and find IPs matching your criteria. The scan may take several minutes.</p>
                <button class="btn btn-primary" onclick="startInitialScan()" style="width: 100%;">Start Scan</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="clean-dead-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Clean Dead IPs</div>
                <button class="modal-close" onclick="closeCleanDeadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.25rem;">
                    Deactivate IPs whose download speed has been <strong>0</strong> across an entire range of tests.
                </p>
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                        <input type="radio" name="clean-mode" value="tests" checked onchange="updateCleanPreview()"> By last N tests
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                        <input type="radio" name="clean-mode" value="hours" onchange="updateCleanPreview()"> By time range
                    </label>
                </div>
                <div class="ip-details-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="detail-item" id="clean-tests-group">
                        <div class="detail-label">Last N tests with 0 speed</div>
                        <input type="number" class="search-input" id="clean-last-n" value="10" min="1" style="width: 100%;" oninput="updateCleanPreview()">
                    </div>
                    <div class="detail-item" id="clean-hours-group" style="opacity: 0.4;">
                        <div class="detail-label">Hours to look back</div>
                        <select class="search-input" id="clean-hours" style="width: 100%;" onchange="updateCleanPreview()" disabled>
                            <option value="1">1 hour</option>
                            <option value="3">3 hours</option>
                            <option value="6" selected>6 hours</option>
                            <option value="12">12 hours</option>
                            <option value="24">24 hours (1 day)</option>
                            <option value="48">48 hours (2 days)</option>
                            <option value="168">168 hours (7 days)</option>
                        </select>
                    </div>
                </div>
                <div id="clean-preview" style="text-align: center; padding: 0.75rem; margin: 1rem 0; background: var(--bg-secondary); border-radius: 8px; font-size: 0.875rem; color: var(--text-secondary);">
                    Click preview to see affected IPs
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-secondary" onclick="updateCleanPreview()" style="flex: 1;">Preview</button>
                    <button class="btn btn-danger" id="clean-execute-btn" onclick="executeCleanDead()" style="flex: 1;">Deactivate</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        let currentSort = 'avg_download_speed';
        let sortDir = 'DESC';

        function showToast(message, type) {
            type = type || 'success';
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = message;
            container.appendChild(toast);
            setTimeout(function() { toast.style.opacity = '0'; setTimeout(function() { toast.remove(); }, 300); }, 3000);
        }

        async function fetchAPI(url, options) {
            options = options || {};
            try {
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast('API Error: ' + error.message, 'error');
                return null;
            }
        }

        async function loadStats() {
            const data = await fetchAPI('/api/stats');
            if (!data) return;
            document.getElementById('stat-active-ips').textContent = data.total_active_ips || 0;
            document.getElementById('stat-total-tests').textContent = data.total_tests || 0;
            document.getElementById('stat-avg-speed').textContent = (data.avg_speed || 0).toFixed(2);
            document.getElementById('stat-best-speed').textContent = (data.best_speed || 0).toFixed(2);
            document.getElementById('stat-avg-latency').textContent = (data.avg_latency || 0).toFixed(0);
            document.getElementById('stat-best-latency').textContent = (data.best_latency || 0).toFixed(0);
            if (data.monitor) updateMonitorStatus(data.monitor);
            if (data.scanner) updateScanStatus(data.scanner);
        }

        function updateMonitorStatus(status) {
            const dot = document.getElementById('monitor-dot');
            const text = document.getElementById('monitor-status-text');
            const btn = document.getElementById('monitor-toggle-btn');
            const interval = document.getElementById('monitor-interval');
            const next = document.getElementById('monitor-next');

            if (status.is_running) {
                dot.className = 'status-dot running';
                text.textContent = 'Running';
                btn.textContent = 'Stop';
                btn.className = 'btn btn-sm btn-danger';
                interval.textContent = 'Interval: ' + status.interval_seconds + 's';
                if (status.next_test_in !== null) next.textContent = 'Next: ' + status.next_test_in + 's';
            } else {
                dot.className = 'status-dot stopped';
                text.textContent = 'Stopped';
                btn.textContent = 'Start';
                btn.className = 'btn btn-sm btn-secondary';
                interval.textContent = '';
                next.textContent = '';
            }
        }

        async function loadIPs() {
            const search = document.getElementById('search-input').value;
            const url = '/api/ips?sort=' + currentSort + '&dir=' + sortDir + (search ? '&search=' + encodeURIComponent(search) : '');
            const data = await fetchAPI(url);
            if (!data) return;
            renderIPTable(data.ips || []);
        }

        function renderIPTable(ips) {
            const tbody = document.getElementById('ip-table-body');
            if (ips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">No Data</div><div>No IPs found. Run an initial scan.</div></td></tr>';
                return;
            }
            tbody.innerHTML = ips.map(function(ip) {
                const speedClass = ip.avg_download_speed >= 15 ? 'speed-good' : (ip.avg_download_speed >= 8 ? 'speed-medium' : 'speed-bad');
                const lossClass = ip.avg_loss_rate <= 0.1 ? 'speed-good' : (ip.avg_loss_rate <= 0.25 ? 'speed-medium' : 'speed-bad');
                const lastTested = ip.last_tested ? new Date(ip.last_tested).toLocaleString() : 'Never';
                return '<tr>' +
                    '<td class="ip-cell" onclick="showIPDetails(\'' + ip.ip_address + '\')">' + ip.ip_address + '</td>' +
                    '<td class="' + speedClass + '">' + (ip.avg_download_speed || 0).toFixed(2) + '</td>' +
                    '<td class="' + speedClass + '">' + (ip.best_download_speed || 0).toFixed(2) + '</td>' +
                    '<td>' + (ip.avg_latency || 0).toFixed(0) + '</td>' +
                    '<td>' + (ip.best_latency || 0).toFixed(0) + '</td>' +
                    '<td class="' + lossClass + '">' + ((ip.avg_loss_rate || 0) * 100).toFixed(1) + '%</td>' +
                    '<td>' + (ip.total_tests || 0) + '</td>' +
                    '<td style="font-size: 0.7rem;">' + lastTested + '</td>' +
                    '<td><button class="btn btn-sm btn-danger" onclick="deactivateIP(\'' + ip.ip_address + '\')">X</button></td>' +
                    '</tr>';
            }).join('');
        }

        async function loadHourlyChart() {
            const data = await fetchAPI('/api/hourly?hours=24');
            if (!data || !data.stats || data.stats.length === 0) {
                document.getElementById('hourly-chart').innerHTML = '<div class="empty-state">No data available</div>';
                return;
            }
            const maxSpeed = Math.max.apply(null, data.stats.map(function(s) { return s.avg_speed || 0; }));
            const container = document.getElementById('hourly-chart');
            container.innerHTML = data.stats.map(function(stat) {
                const height = maxSpeed > 0 ? ((stat.avg_speed || 0) / maxSpeed * 100) : 0;
                return '<div class="chart-bar" style="height: ' + height + '%;" title="' + (stat.avg_speed || 0).toFixed(1) + ' MB/s"></div>';
            }).join('');
        }

        async function showIPDetails(ip) {
            document.getElementById('ip-modal').classList.add('active');
            document.getElementById('modal-ip-title').textContent = 'IP: ' + ip;
            document.getElementById('modal-body').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            const results = await Promise.all([
                fetchAPI('/api/ip?ip=' + encodeURIComponent(ip)),
                fetchAPI('/api/history?ip=' + encodeURIComponent(ip) + '&hours=24')
            ]);
            const details = results[0];
            const history = results[1];
            if (!details) { document.getElementById('modal-body').innerHTML = '<div class="empty-state">Failed to load</div>'; return; }
            let html = '<div class="ip-details-grid">' +
                '<div class="detail-item"><div class="detail-label">Avg Speed</div><div class="detail-value">' + (details.avg_download_speed || 0).toFixed(2) + ' MB/s</div></div>' +
                '<div class="detail-item"><div class="detail-label">Best Speed</div><div class="detail-value">' + (details.best_download_speed || 0).toFixed(2) + ' MB/s</div></div>' +
                '<div class="detail-item"><div class="detail-label">Avg Latency</div><div class="detail-value">' + (details.avg_latency || 0).toFixed(0) + ' ms</div></div>' +
                '<div class="detail-item"><div class="detail-label">Best Latency</div><div class="detail-value">' + (details.best_latency || 0).toFixed(0) + ' ms</div></div>' +
                '<div class="detail-item"><div class="detail-label">Avg Loss</div><div class="detail-value">' + ((details.avg_loss_rate || 0) * 100).toFixed(1) + '%</div></div>' +
                '<div class="detail-item"><div class="detail-label">Total Tests</div><div class="detail-value">' + (details.total_tests || 0) + '</div></div></div>';
            if (history && history.history && history.history.length > 0) {
                html += '<h4 style="margin: 1rem 0 0.5rem;">Recent History (24h)</h4><div class="table-container"><table><thead><tr><th>Time</th><th>Speed</th><th>Latency</th><th>Loss</th></tr></thead><tbody>';
                html += history.history.slice(0, 20).map(function(h) {
                    return '<tr><td style="font-size: 0.75rem;">' + new Date(h.test_time).toLocaleString() + '</td><td>' + (h.download_speed_mbps || 0).toFixed(2) + '</td><td>' + (h.latency_ms || 0).toFixed(0) + '</td><td>' + ((h.loss_rate || 0) * 100).toFixed(1) + '%</td></tr>';
                }).join('');
                html += '</tbody></table></div>';
            }
            document.getElementById('modal-body').innerHTML = html;
        }

        function closeModal() { document.getElementById('ip-modal').classList.remove('active'); }
        function showScanModal() { document.getElementById('scan-modal').classList.add('active'); }
        function closeScanModal() { document.getElementById('scan-modal').classList.remove('active'); }

        async function startInitialScan() {
            const data = {
                min_speed: parseFloat(document.getElementById('scan-min-speed').value),
                max_latency: parseInt(document.getElementById('scan-max-latency').value),
                max_loss: parseFloat(document.getElementById('scan-max-loss').value),
                test_count: parseInt(document.getElementById('scan-test-count').value)
            };
            const result = await fetchAPI('/api/scan/initial', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            if (result) {
                showToast('Initial scan started! This may take several minutes.', 'success');
                closeScanModal();
                startScanPolling();
            }
        }

        async function testNow() {
            const result = await fetchAPI('/api/scan/test', { method: 'POST' });
            if (result) { showToast('Test started!', 'success'); setTimeout(refreshData, 5000); }
        }

        async function toggleMonitor() {
            const status = await fetchAPI('/api/monitor/status');
            const endpoint = status && status.is_running ? '/api/monitor/stop' : '/api/monitor/start';
            const interval = parseInt(document.getElementById('interval-select').value);
            const result = await fetchAPI(endpoint, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: interval}) });
            if (result) { showToast('Monitor ' + (result.status === 'started' ? 'started' : 'stopped'), 'success'); loadStats(); }
        }

        async function setMonitorInterval(seconds) {
            await fetchAPI('/api/monitor/interval', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: parseInt(seconds)}) });
            loadStats();
        }

        async function deactivateIP(ip) {
            if (!confirm('Deactivate IP ' + ip + '?')) return;
            const result = await fetchAPI('/api/ip/deactivate', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ip: ip}) });
            if (result) { showToast('IP deactivated', 'success'); loadIPs(); loadStats(); }
        }

        function filterIPs() { loadIPs(); }
        function sortIPs() {
            currentSort = document.getElementById('sort-select').value;
            sortDir = (currentSort === 'avg_latency' || currentSort === 'avg_loss_rate') ? 'ASC' : 'DESC';
            loadIPs();
        }

        var _scanPollTimer = null;
        var _wasScanningLast = false;

        function startScanPolling() {
            if (_scanPollTimer) return;
            _scanPollTimer = setInterval(function() { loadStats(); }, 3000);
        }

        function stopScanPolling() {
            if (_scanPollTimer) {
                clearInterval(_scanPollTimer);
                _scanPollTimer = null;
            }
        }

        function updateScanStatus(status) {
            var dot = document.getElementById('scan-sched-dot');
            var text = document.getElementById('scan-sched-status-text');
            var toggleBtn = document.getElementById('scan-sched-toggle-btn');
            var stopBtn = document.getElementById('scan-stop-btn');
            var headerStopBtn = document.getElementById('header-stop-scan-btn');
            var runningText = document.getElementById('scan-running-text');
            var intervalSelect = document.getElementById('scan-interval-select');

            if (status.schedule && status.schedule.is_running) {
                dot.className = 'status-dot running';
                text.textContent = 'Scheduled (' + status.schedule.scan_count + ' runs)';
                toggleBtn.textContent = 'Stop';
                toggleBtn.className = 'btn btn-sm btn-danger';
            } else {
                dot.className = 'status-dot stopped';
                text.textContent = 'Off';
                toggleBtn.textContent = 'Start';
                toggleBtn.className = 'btn btn-sm btn-secondary';
            }

            // Sync dropdown with actual configured interval
            if (status.schedule && status.schedule.interval_seconds) {
                var val = String(status.schedule.interval_seconds);
                if (intervalSelect.querySelector('option[value="' + val + '"]')) {
                    intervalSelect.value = val;
                }
            }

            if (status.is_scanning) {
                stopBtn.style.display = '';
                headerStopBtn.style.display = '';
                var elapsed = status.elapsed_seconds || 0;
                var min = Math.floor(elapsed / 60);
                var sec = elapsed % 60;
                runningText.textContent = 'Scanning... ' + (min > 0 ? min + 'm ' : '') + sec + 's';
                startScanPolling();
            } else {
                stopBtn.style.display = 'none';
                headerStopBtn.style.display = 'none';
                runningText.textContent = '';
                if (_wasScanningLast) {
                    stopScanPolling();
                    var lastResult = status.last_result;
                    if (lastResult && lastResult.status === 'completed') {
                        showToast('Scan completed! Found ' + (lastResult.passed || 0) + ' IPs in ' + (lastResult.duration_seconds || 0).toFixed(0) + 's', 'success');
                    } else if (lastResult && lastResult.status === 'cancelled') {
                        showToast('Scan was cancelled', 'error');
                    } else if (lastResult && lastResult.status === 'error') {
                        showToast('Scan failed: ' + (lastResult.error || 'unknown error'), 'error');
                    }
                    loadIPs();
                    loadHourlyChart();
                }
            }
            _wasScanningLast = status.is_scanning;
        }

        async function stopCurrentScan() {
            var result = await fetchAPI('/api/scan/stop', { method: 'POST' });
            if (result) { showToast('Scan stop requested', 'success'); setTimeout(refreshData, 2000); }
        }

        async function toggleScanSchedule() {
            var status = await fetchAPI('/api/scan/status');
            var endpoint = status && status.schedule && status.schedule.is_running ? '/api/scan/schedule/stop' : '/api/scan/schedule/start';
            var interval = parseInt(document.getElementById('scan-interval-select').value);
            var result = await fetchAPI(endpoint, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: interval}) });
            if (result) { showToast('Scan scheduler ' + result.status, 'success'); loadStats(); }
        }

        async function setScanScheduleInterval(seconds) {
            await fetchAPI('/api/scan/schedule/interval', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: parseInt(seconds)}) });
            loadStats();
        }

        async function deactivateAllIPs() {
            if (!confirm('Deactivate ALL active IPs? This cannot be undone.')) return;
            if (!confirm('Are you sure? Every active IP will be removed from the list.')) return;
            const result = await fetchAPI('/api/ips/deactivate-all', { method: 'POST' });
            if (result) { showToast('Deactivated ' + result.count + ' IPs', 'success'); refreshData(); }
        }

        function showCleanDeadModal() { document.getElementById('clean-dead-modal').classList.add('active'); updateCleanPreview(); }
        function closeCleanDeadModal() { document.getElementById('clean-dead-modal').classList.remove('active'); }

        function getCleanMode() {
            return document.querySelector('input[name="clean-mode"]:checked').value;
        }

        document.querySelectorAll('input[name="clean-mode"]').forEach(function(r) {
            r.addEventListener('change', function() {
                var isTests = getCleanMode() === 'tests';
                document.getElementById('clean-tests-group').style.opacity = isTests ? '1' : '0.4';
                document.getElementById('clean-last-n').disabled = !isTests;
                document.getElementById('clean-hours-group').style.opacity = isTests ? '0.4' : '1';
                document.getElementById('clean-hours').disabled = isTests;
            });
        });

        async function updateCleanPreview() {
            var mode = getCleanMode();
            var value = mode === 'tests'
                ? parseInt(document.getElementById('clean-last-n').value)
                : parseInt(document.getElementById('clean-hours').value);
            document.getElementById('clean-preview').innerHTML = '<div class="spinner" style="width:20px;height:20px;margin:0 auto;"></div>';
            var result = await fetchAPI('/api/ips/preview-dead?mode=' + mode + '&value=' + value);
            if (result) {
                var label = mode === 'tests'
                    ? 'with 0 speed in last ' + value + ' tests'
                    : 'with 0 speed in last ' + value + ' hours';
                document.getElementById('clean-preview').innerHTML =
                    '<span style="font-size: 1.25rem; font-weight: 700; color: var(--accent-danger);">' + result.count + '</span> IPs ' + label;
            }
        }

        async function executeCleanDead() {
            var mode = getCleanMode();
            var value = mode === 'tests'
                ? parseInt(document.getElementById('clean-last-n').value)
                : parseInt(document.getElementById('clean-hours').value);
            var label = mode === 'tests' ? 'last ' + value + ' tests' : 'last ' + value + ' hours';
            if (!confirm('Deactivate all IPs with 0 download speed in ' + label + '?')) return;
            var result = await fetchAPI('/api/ips/deactivate-dead', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ mode: mode, value: value })
            });
            if (result) {
                showToast('Deactivated ' + result.count + ' dead IPs', 'success');
                closeCleanDeadModal();
                refreshData();
            }
        }

        function refreshData() { loadStats(); loadIPs(); loadHourlyChart(); }
        setInterval(function() { loadStats(); }, 30000);
        setInterval(function() { loadIPs(); loadHourlyChart(); }, 120000);
        document.addEventListener('DOMContentLoaded', function() { refreshData(); });
        document.querySelectorAll('.modal-overlay').forEach(function(modal) { modal.addEventListener('click', function(e) { if (e.target === modal) modal.classList.remove('active'); }); });
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(function(m) { m.classList.remove('active'); }); if (e.key === 'r' && document.activeElement.tagName !== 'INPUT') refreshData(); });
    </script>
</body>
</html>
